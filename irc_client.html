<!DOCTYPE html>
<html>
<head>
<title>JS IRC Client</title>
</head>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript">

function parse_msg( text ) {
	var data = text.split( " ", 4 );
	if ( data.length == 4 && data[1] == 'PRIVMSG' ) {
		var user = text.split( '!~' )[0].replace( ':', '' );
		var message = text.replace( /^:[^:]*:/, '' ).replace( /[\n\r]/g, '' );
		var receiver = null;
		/* The person we want to answer (channel or user). */
		if ( data[2].charAt(0) == '#' ) {
			receiver = data[2]; // channel
		} else {
			receiver = user; // user
		}
		return { 
				'valid'    : 1, 
				'user'     : user, 
				'channel'  : data[2], 
				'receiver' : receiver, 
				'message'  : message
			}
	} else {
		// not a valid message
		return { 'valid' : 0 }
	}
}


//var socket = io.connect( window.location.host );
var socket = io.connect( window.location.host );

$(document).ready( function () {
	$("#ui").hide();

	$("#connect-btn").click( function(e) {
		e.preventDefault();
		/* UI thingsâ€¦ */
		$("#connect").hide();
		$("#ui").show();
		alert( [ $(window).innerHeight(), $('#bottom-box').outerHeight(), $('#top-box').height(), $('#top-box').outerHeight() ] );
		alert( $(window).innerHeight() - $('#bottom-box').outerHeight() + $('#top-box').height() - $('#top-box').outerHeight() );
		$('#top-box').height( $(window).innerHeight() - $('#bottom-box').outerHeight() - 5 );
		$('#top-box ul').height( $('#top-box').innerHeight() - 2 );


		/* Connect to IRC. */
		socket.send("CONNECT "+ $("#server").val());
		socket.send("NICK "+ $("#nick").val() +"\n");
		socket.send("USER "+ $("#nick").val() +" "+  $("#server").val().split(":")[0] + " blubb :"+$("#nick").val() +"\n");
	});

});

//socket.send("JOIN #las-vegas-uos\n");

socket.on('message', function (data) {
		var lines = data.split( "\r\n" );
		for ( var i = 0; i < lines.length; i++ )  {
			// play ping pong
			if ( lines[i].match( /^PING.*/ ) ) {
				socket.send( 'PONG ' + lines[i].split(' ')[1] + '\r\n' );
			} else if ( lines[i] != ''  ) {
				$("#messages").append( "<li>" + lines[i] + "</li>")
					.stop().animate({scrollTop: 
						$("#messages").children().last().offset().top
						+ $("#messages").children().last().outerHeight() + 100 }, 500);
			}
		}
	 });

</script>
<body style="padding: 0px; margin:0px;">
	<div id="connect" style="text-align: center; margin:0px;">
		<form>
			<label for="server">Server: </label><input type="text" id="server" required value="irc.freenode.net:6667" /><br>
			<input type="text" id="nick" required placeholder="Your nickname here" />
			<input type="submit" id="connect-btn" value="connect" />
		</form>
	</div>
	<div id="ui" style="display: table; width: 100%; padding: 0px; margin: 0px;">
		<div id="top-box" style="height: 500px; display: table; width: 100%; padding: 0px; margin: 0px;">
			<div style="display: table-row; width: 100%; padding: 0px; margin: 0px;">
				<div style="display: table-cell; padding: 0px; margin: 0px;">
				<ul style="height: 500px; width: 95%; font-size: smaller; display: block; overflow-y: scroll; overflow-x: hidden; list-style-type: none; margin: 0px;" id="messages">
					<li>Welcome to IRC webclient</li>
				</ul>
			</div>
			<div id="userlist"
					style="width: 18%; height: 100%; background-color: #bbbbbb; display: table-cell; overflow: scroll; margin: 0px;"></div>
			</div>
		</div>
		<div id="bottom-box">
			<input type="text" id="msginput" style="width: 82%" /><input
			type="submit" />
		</div>
	</div>
</body>
</html>
